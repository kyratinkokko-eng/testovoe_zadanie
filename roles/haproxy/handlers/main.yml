---
# ============================================================
#  Handlers: graceful reload HAProxy + systemd persistence
# ============================================================

- name: Reload HAProxy
  ansible.builtin.command:
    cmd: docker exec haproxy haproxy -c -f /usr/local/etc/haproxy/haproxy.cfg
  register: haproxy_validate
  changed_when: haproxy_validate.rc == 0
  notify: Send SIGUSR2 to HAProxy

- name: Send SIGUSR2 to HAProxy
  ansible.builtin.command:
    cmd: docker kill --signal=USR2 haproxy
  when: haproxy_validate.rc == 0

- name: Enable tproxy-routing service
  ansible.builtin.systemd:
    name: tproxy-routing
    enabled: true
    daemon_reload: true
    state: started
