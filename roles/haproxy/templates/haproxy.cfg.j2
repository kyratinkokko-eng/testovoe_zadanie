# ============================================================
#  HAProxy — Active-Active MTProxy Load Balancer
#  Режим: TCP с балансировкой и активными health checks
#  TPROXY (usesrc clientip) опционален — см. haproxy_tproxy
#  Сгенерировано Ansible — не редактировать вручную
# ============================================================

global
    log stdout format raw local0
    maxconn 4096

defaults
    mode    tcp
    log     global
    option  tcplog
    option  tcp-check
    timeout connect 5s
    timeout client  60s
    timeout server  60s

# -----------------------------------------------------------
#  Frontend: единая точка входа для Telegram-клиентов
# -----------------------------------------------------------
frontend mtproxy_front
    bind *:{{ haproxy_frontend_port }}
    default_backend mtproxy_back

# -----------------------------------------------------------
#  Backend: MTProxy инстансы
#  TPROXY (source 0.0.0.0 usesrc clientip) включается
#  переменной haproxy_tproxy: true — требует HAProxy и бэкенды
#  на РАЗНЫХ хостах или в разных network namespace
# -----------------------------------------------------------
backend mtproxy_back
    balance {{ haproxy_balance }}
{% if haproxy_tproxy | default(false) | bool %}
    source 0.0.0.0 usesrc clientip
{% endif %}
{% for i in range(1, mtproxy_replicas + 1) %}
    server mtproxy_{{ i }} 127.0.0.1:{{ mtproxy_base_port + i - 1 }} check inter 3s fall 2 rise 2
{% endfor %}

# -----------------------------------------------------------
#  Stats: мониторинг и проверка состояния бэкендов
# -----------------------------------------------------------
listen stats
    bind *:{{ haproxy_stats_port }}
    mode http
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats auth {{ haproxy_stats_user }}:{{ haproxy_stats_password }}
    stats admin if TRUE
