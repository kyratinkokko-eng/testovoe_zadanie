---
# ============================================================
#  Роль: haproxy — TPROXY-настройка балансера, деплой конфига,
#  запуск контейнера HAProxy в master-worker режиме
# ============================================================

# -----------------------------------------------------------
#  1. Sysctl: разрешить биндинг на нелокальные IP (TPROXY)
#     Персистентно через /etc/sysctl.d/
# -----------------------------------------------------------
- name: "Sysctl: enable ip_nonlocal_bind for TPROXY"
  ansible.posix.sysctl:
    name: net.ipv4.ip_nonlocal_bind
    value: "1"
    sysctl_set: true
    state: present
    reload: true

- name: "Sysctl: enable ip_forward"
  ansible.posix.sysctl:
    name: net.ipv4.ip_forward
    value: "1"
    sysctl_set: true
    state: present
    reload: true

# -----------------------------------------------------------
#  2. TPROXY: ip rule + ip route
#     Пакеты с fwmark 1 обрабатываются как local —
#     ядро доставляет их в TPROXY-сокет HAProxy
# -----------------------------------------------------------
- name: "TPROXY: clean up duplicate ip rules"
  ansible.builtin.shell: |
    while ip rule del fwmark 1 lookup 100 2>/dev/null; do :; done
  changed_when: false

- name: "TPROXY: add ip rule fwmark 1 lookup 100"
  ansible.builtin.command:
    cmd: ip rule add fwmark 1 lookup 100
  register: ip_rule_result
  changed_when: ip_rule_result.rc == 0
  failed_when: ip_rule_result.rc != 0 and 'File exists' not in ip_rule_result.stderr

- name: "TPROXY: add local route in table 100"
  ansible.builtin.command:
    cmd: ip route add local 0.0.0.0/0 dev lo table 100
  register: ip_route_result
  changed_when: ip_route_result.rc == 0
  failed_when: ip_route_result.rc != 0 and 'File exists' not in ip_route_result.stderr

# -----------------------------------------------------------
#  2b. Персистентность ip rule / ip route после ребута
# -----------------------------------------------------------
- name: "TPROXY: deploy systemd unit for persistent routing"
  ansible.builtin.copy:
    dest: /etc/systemd/system/tproxy-routing.service
    mode: "0644"
    content: |
      [Unit]
      Description=TPROXY routing rules for HAProxy transparent proxy
      After=network-online.target
      Wants=network-online.target

      [Service]
      Type=oneshot
      RemainAfterExit=yes
      ExecStart=/bin/sh -c '/sbin/ip rule add fwmark 1 lookup 100 2>/dev/null || true'
      ExecStart=/bin/sh -c '/sbin/ip route add local 0.0.0.0/0 dev lo table 100 2>/dev/null || true'
      ExecStop=/sbin/ip rule del fwmark 1 lookup 100
      ExecStop=/sbin/ip route del local 0.0.0.0/0 dev lo table 100

      [Install]
      WantedBy=multi-user.target
  notify: Enable tproxy-routing service

# -----------------------------------------------------------
#  3. TPROXY iptables: PREROUTING на wg0 для return-трафика
#     Ответы от MTProxy приходят через WireGuard с sport=443x
#     → помечаются → policy routing доставляет в TPROXY-сокет
# -----------------------------------------------------------
- name: "TPROXY: mark return traffic on WireGuard (PREROUTING)"
  ansible.builtin.shell: |
    iptables -t mangle -C PREROUTING -i wg0 -p tcp --sport {{ mtproxy_base_port + item - 1 }} -j MARK --set-mark 0x1/0x1 2>/dev/null \
    || iptables -t mangle -A PREROUTING -i wg0 -p tcp --sport {{ mtproxy_base_port + item - 1 }} -j MARK --set-mark 0x1/0x1
  loop: "{{ range(1, mtproxy_replicas + 1) | list }}"
  loop_control:
    label: "port {{ mtproxy_base_port + item - 1 }}"
  register: iptables_result
  changed_when: "'already' not in iptables_result.stderr"
  when: haproxy_tproxy | bool

# -----------------------------------------------------------
#  3b. Персистентность iptables через iptables-persistent
# -----------------------------------------------------------
- name: Install iptables-persistent for rule persistence
  ansible.builtin.apt:
    name: iptables-persistent
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive

- name: Save iptables rules for persistence across reboots
  ansible.builtin.shell: iptables-save > /etc/iptables/rules.v4
  changed_when: true

# -----------------------------------------------------------
#  4. Создать каталог и отрендерить конфиг HAProxy
# -----------------------------------------------------------
- name: Create HAProxy config directory
  ansible.builtin.file:
    path: "{{ haproxy_config_dir }}"
    state: directory
    mode: "0755"

- name: Render HAProxy configuration from template
  ansible.builtin.template:
    src: haproxy.cfg.j2
    dest: "{{ haproxy_config_path }}"
    mode: "0644"
  notify: Reload HAProxy

# -----------------------------------------------------------
#  5. Pull и запуск контейнера HAProxy
# -----------------------------------------------------------
- name: Pull HAProxy image
  community.docker.docker_image:
    name: "{{ haproxy_image }}"
    source: pull

- name: Run HAProxy container (host network + TPROXY capabilities)
  community.docker.docker_container:
    name: haproxy
    image: "{{ haproxy_image }}"
    state: started
    restart_policy: unless-stopped
    network_mode: host
    user: "root:root"
    capabilities:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - "{{ haproxy_config_path }}:/usr/local/etc/haproxy/haproxy.cfg:ro"
    command: "haproxy -W -f /usr/local/etc/haproxy/haproxy.cfg"
