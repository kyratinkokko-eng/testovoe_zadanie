---
# ============================================================
#  Роль: mtproxy — запуск N инстансов MTProxy
# ============================================================

- name: Pull MTProxy image
  community.docker.docker_image:
    name: "{{ mtproxy_image }}"
    source: pull

- name: Create MTProxy run script directory
  ansible.builtin.file:
    path: /opt/mtproxy
    state: directory
    mode: "0755"

- name: Deploy custom run.sh (respects PORT env variable)
  ansible.builtin.template:
    src: run.sh.j2
    dest: /opt/mtproxy/run.sh
    mode: "0755"
  notify: Restart MTProxy containers

- name: Create MTProxy containers
  community.docker.docker_container:
    name: "mtproxy_{{ item }}"
    image: "{{ mtproxy_image }}"
    state: started
    restart_policy: unless-stopped
    network_mode: host
    env:
      SECRET: "{{ mtproxy_secret }}"
      PORT: "{{ (mtproxy_base_port + item - 1) | string }}"
      STATS_PORT: "{{ (2398 + item - 1) | string }}"
      WORKERS: "2"
    volumes:
      - "mtproxy_data_{{ item }}:/data"
      - "/opt/mtproxy/run.sh:/run.sh:ro"
  loop: "{{ range(1, mtproxy_replicas + 1) | list }}"
  loop_control:
    label: "mtproxy_{{ item }} → port {{ mtproxy_base_port + item - 1 }}"

# -----------------------------------------------------------
#  Scale-down: удалить контейнеры с индексом > mtproxy_replicas
# -----------------------------------------------------------
- name: "Scale-down: stop and remove extra MTProxy containers"
  community.docker.docker_container:
    name: "mtproxy_{{ item }}"
    state: absent
  loop: "{{ range(mtproxy_replicas + 1, mtproxy_max_cleanup_index + 1) | list }}"
  loop_control:
    label: "mtproxy_{{ item }} (cleanup)"
  when: mtproxy_replicas < mtproxy_max_cleanup_index
