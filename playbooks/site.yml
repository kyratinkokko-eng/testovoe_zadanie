---
# ============================================================
#  Multi-host MTProxy с TPROXY через WireGuard туннель
#
#  Архитектура:
#    Client → HAProxy (balancer, TPROXY) → WireGuard → MTProxy (backend)
#
#  Использование:
#    ansible-galaxy collection install -r requirements.yml
#    ansible-playbook -i inventory/hosts.yml playbooks/site.yml
# ============================================================

# -----------------------------------------------------------
#  Play 1: WireGuard туннель между балансером и бэкендами
# -----------------------------------------------------------
- name: Setup WireGuard tunnel
  hosts: all
  become: true

  pre_tasks:
    - name: Verify target OS is Debian/Ubuntu
      ansible.builtin.assert:
        that:
          - ansible_facts['os_family'] == "Debian"
        fail_msg: "This playbook supports Debian/Ubuntu only. Detected: {{ ansible_facts['os_family'] }}"

    - name: Remove broken apt repositories (bullseye-backports, etc.)
      ansible.builtin.file:
        path: "/etc/apt/sources.list.d/{{ item }}"
        state: absent
      loop:
        - backports.list
      ignore_errors: true

  roles:
    - wireguard

# -----------------------------------------------------------
#  Play 2: MTProxy бэкенды + TPROXY return routing
# -----------------------------------------------------------
- name: Deploy MTProxy backends
  hosts: backends
  become: true

  roles:
    - docker
    - mtproxy
    - tproxy_backend
    - mtproxy_dashboard

  tasks:
    - name: Stop old HAProxy container (moved to balancer)
      community.docker.docker_container:
        name: haproxy
        state: absent

# -----------------------------------------------------------
#  Play 3: HAProxy балансер с TPROXY
# -----------------------------------------------------------
- name: Deploy HAProxy balancer with TPROXY
  hosts: balancers
  become: true

  roles:
    - docker
    - haproxy
